<!DOCTYPE html>
<html>
<head>
  <title>FixMyLocal Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 90vh; width: 100vw; }
    #legend, #filterBox {
      padding: 0.5rem;
      background: #fff;
      position: absolute;
      z-index: 1000;
      margin: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #legend { bottom: 1rem; left: 1rem; }
    #filterBox { top: 1rem; left: 1rem; }
    table { border-collapse: collapse; }
    td { padding: 4px 8px; vertical-align: middle; }
    .color-box {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 1px solid #888;
      margin-right: 5px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="filterBox">
  <label for="filterSelect"><b>Filter by Issue:</b></label>
  <select id="filterSelect">
    <option value="All">All</option>
    <option value="Water">Water</option>
    <option value="Road">Road</option>
    <option value="Electricity">Electricity</option>
    <option value="Other">Other</option>
  </select>
</div>

<div id="legend">
  <b>Legend:</b>
  <table>
    <tr><td><div class="color-box" style="background:blue"></div></td><td>Water</td></tr>
    <tr><td><div class="color-box" style="background:orange"></div></td><td>Road</td></tr>
    <tr><td><div class="color-box" style="background:red"></div></td><td>Electricity</td></tr>
    <tr><td><div class="color-box" style="background:green"></div></td><td>Other</td></tr>
    <tr><td><div class="color-box" style="background:gold"></div></td><td>Resolved</td></tr>
  </table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([20.5937, 78.9629], 5); // India center

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  const iconColors = {
    Water: 'blue',
    Road: 'orange',
    Electricity: 'red',
    Other: 'green'
  };

  function getIcon(type, status) {
    const color = (status === 'resolved') ? 'gold' : iconColors[type] || 'gray';  // Use 'gold' for resolved issues

    return L.icon({
      iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
      iconSize: [25, 41], // Same size for all markers
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
      shadowSize: [41, 41]
    });
  }

  let allMarkers = [];

  function updateMarkers(filterType) {
    allMarkers.forEach(marker => map.removeLayer(marker));
    allMarkers = [];

    fetch('/data')
      .then(res => res.json())
      .then(reports => {
        reports.forEach(report => {
          if (filterType !== 'All' && report.type !== filterType) return;

          const marker = L.marker([report.lat, report.lng], {
            icon: getIcon(report.type, report.status)
          }).addTo(map);

          marker.bindPopup(`
            <b>${report.type}</b><br/>
            ${report.description}<br/>
            <i>Status: ${report.status}</i><br/>
            <small>${new Date(report.timestamp).toLocaleString()}</small>
          `);
          allMarkers.push(marker);
        });
      });
  }

  document.getElementById('filterSelect').addEventListener('change', () => {
    const selected = document.getElementById('filterSelect').value;
    updateMarkers(selected);
  });

  // Load all on start
  updateMarkers('All');
</script>

</body>
</html>
